<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Générateur de Collage - MET</title>
  <!-- Inclusion de p5.js depuis un CDN -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
</head>
<body>
  <h1>Collage MET</h1>
  <p>Clique sur le canevas pour générer un nouveau collage.</p>
  <div id="loading" style="display: none; text-align: center; font-size: 1.2rem; color: gray;">Chargement des images...</div>
  <script>
    // Nombre d'images à charger
    const NUM_IMAGES = 5;

    // Tableau qui stockera les objets images p5.js
    let images = [];

    function setup() {
      createCanvas(800, 600);
      background(220);

      // Charger des images au démarrage
      loadRandomImages(NUM_IMAGES);
    }

    function draw() {
      background(220);

      // Afficher chaque image à une position et une taille aléatoires
      for (let img of images) {
        let x = random(width);
        let y = random(height);

        let maxW = random(100, 300); // Taille maximale
        let ratio = img.height / img.width;
        let w = maxW;
        let h = w * ratio;

        image(img, x, y, w, h);
      }

      // Arrêter la boucle draw après la première exécution
      noLoop();
    }

    function mousePressed() {
      // Recharger de nouvelles images lorsque l'utilisateur clique
      loadRandomImages(NUM_IMAGES);
    }

    function loadRandomImages(n) {
      // Afficher le message de chargement
      document.getElementById('loading').style.display = 'block';

      // Vider le tableau d'images
      images = [];

      fetch('https://collectionapi.metmuseum.org/public/collection/v1/objects')
        .then(response => response.json())
        .then(data => {
          const total = data.total;
          const objectIDs = data.objectIDs;

          let promises = [];
          for (let i = 0; i < n; i++) {
            let randomIndex = Math.floor(Math.random() * total);
            let id = objectIDs[randomIndex];

            let p = fetch(`https://collectionapi.metmuseum.org/public/collection/v1/objects/${id}`)
              .then(res => res.json())
              .then(objData => {
                if (objData && objData.primaryImage && objData.primaryImage !== '') {
                  return loadImageAsync(objData.primaryImage);
                } else {
                  return null;
                }
              });
            promises.push(p);
          }

          Promise.all(promises).then(results => {
            results = results.filter(img => img !== null);

            if (results.length === 0) {
              console.log("Aucune image trouvée, réessayez!");
            }

            images = results;

            // Cacher le message de chargement
            document.getElementById('loading').style.display = 'none';

            redraw();
          });
        })
        .catch(err => {
          console.error(err);
          document.getElementById('loading').textContent = "Erreur lors du chargement.";
        });
    }

    // Fonction pour charger une image avec une Promise
    function loadImageAsync(url) {
      return new Promise((resolve, reject) => {
        loadImage(url, img => resolve(img), err => reject(err));
      });
    }
  </script>
</body>
</html>
